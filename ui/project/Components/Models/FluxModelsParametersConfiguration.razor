@using DiffusionPipeInterface.Models
@using DiffusionPipeInterface.Utils
@using DiffusionPipeInterface.ViewModels.Models
@using Enums
@inject IConfiguration Configuration
@inject AppSettingsConfiguration AppSettingsConfiguration
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime

<MudTextField @bind-Value="ModelConfiguration.DiffusersPath" Required Label="Diffusers Path" Disabled="Locked" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Link" OnAdornmentClick=@(() => RedirectToLink("https://huggingface.co/black-forest-labs/FLUX.1-dev/tree/main"))></MudTextField>

<MudSelect T="Dtype" @bind-Value="ModelConfiguration.Dtype" Required Label="Dtype" FullWidth="true" Disabled="Locked" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Info" OnAdornmentClick=@(() => OpenDialogAsync(Tooltips.ModelDtype))>
    @foreach (Dtype item in Enum.GetValues(typeof(Dtype)))
    {
        <MudSelectItem Value="@item">@item</MudSelectItem>
    }
</MudSelect>

<MudTextField @bind-Value="ModelConfiguration.TransformerPath" Label="Transformers Path" Disabled="Locked" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Link" OnAdornmentClick=@(() => RedirectToLink("https://huggingface.co/black-forest-labs/FLUX.1-schnell/resolve/main/flux1-schnell.safetensors"))></MudTextField>

<MudSelect T="Dtype?" @bind-Value="ModelConfiguration.TransformerDType" Label="Dtype" FullWidth="true" Disabled="Locked" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Info" OnAdornmentClick=@(() => OpenDialogAsync(Tooltips.TransformerDtype))>
    @foreach (Dtype? item in Enum.GetValues(typeof(Dtype)))
    {
        <MudSelectItem Value="@item">@item</MudSelectItem>
    }
</MudSelect>

<InfoField TooltipText="@Tooltips.FluxShift">
    <FieldContent>
        <MudSwitch @bind-Value="ModelConfiguration.FluxShift" Disabled="Locked" Color="Color.Primary" Label="Enable Flux Shift" />
    </FieldContent>
</InfoField>

<InfoField TooltipText="@Tooltips.BypassGuidanceEmbedding">
    <FieldContent>
        <MudSwitch T="bool?" @bind-Value="ModelConfiguration.BypassGuidanceEmbedding" Disabled="Locked" Color="Color.Primary" Label="Enable Bypass Guidance Embedding" />
    </FieldContent>
</InfoField>


@code {
    [Parameter]
    [EditorRequired]
    public FluxModelConfigurationViewModel ModelConfiguration { get; set; } = null!;
    [Parameter]
    public bool Locked { get; set; } = false;

    protected override void OnInitialized()
    {
        if (Configuration != null && AppSettingsConfiguration != null)
        {
            var defaultConfig = Configuration.GetSection("Configurations:Models:Flux");
            if (defaultConfig != null)
            {
                ModelConfiguration.TransformerPath = string.IsNullOrEmpty(ModelConfiguration.TransformerPath) ? defaultConfig["TransformerPath"]?.Replace("{ModelsPath}", AppSettingsConfiguration.ModelsPath) : ModelConfiguration.TransformerPath;
                ModelConfiguration.DiffusersPath = string.IsNullOrEmpty(ModelConfiguration.DiffusersPath) ? defaultConfig["DiffusersPath"]?.Replace("{ModelsPath}", AppSettingsConfiguration.ModelsPath) : ModelConfiguration.DiffusersPath;
            }
        }
    }

    private Task OpenDialogAsync(string message)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large };

        var parameters = new DialogParameters<InfoDialog>
        {
            { x => x.Message, message }
        };

        return DialogService.ShowAsync<InfoDialog>("Info", parameters, options);
    }

    private void RedirectToLink(string link)
    {
        JSRuntime.InvokeVoidAsync("openNewTab", link);
    }
}